<ng-container *ngIf="vm$ | async as vm">
  <dp-page-layout [accountId]="vm.accountId">
    <dp-page-header
      title="Monitoring"
      subtitle="Состояние подключений и управление синхронизациями."
    >
      <div secondary-actions>
        <dp-button variant="secondary" (click)="refresh()">Refresh</dp-button>
      </div>
      <div primary-action>
        <dp-button variant="primary" (click)="openConnection(vm.accountId)">
          Open connections
        </dp-button>
      </div>
    </dp-page-header>

    <section class="card">
      <ng-container *ngIf="vm.state.status === 'loading'">
        <dp-loading-state label="Loading monitoring"></dp-loading-state>
      </ng-container>

      <ng-container *ngIf="vm.state.status === 'error'">
        <dp-error-state title="Не удалось загрузить мониторинг" [description]="vm.state.error.message">
          <dp-button variant="secondary" (click)="refresh()">Retry</dp-button>
        </dp-error-state>
      </ng-container>

      <ng-container *ngIf="vm.state.status === 'ready'">
        <dp-table *ngIf="vm.state.data.length; else emptyState">
          <table>
            <thead>
            <tr>
              <th>Connection</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
            </thead>

            <tbody>
            <tr *ngFor="let connection of vm.state.data">
              <td>
                <div class="cell-title">{{ connection.marketplace }}</div>
                <div class="cell-subtitle">ID: {{ connection.id }}</div>
              </td>

              <td>
                <div class="status-block">
                  <div class="status-title">{{ statusLabel(connection) }}</div>
                  <div class="status-desc">{{ statusDescription(connection) }}</div>
                </div>
              </td>

              <td>
                <div class="actions">
                  <dp-button size="sm" variant="secondary" (click)="openConnection(vm.accountId)">
                    Fix connection
                  </dp-button>

                  <dp-button
                    size="sm"
                    variant="primary"
                    (click)="runScenarioSync(vm.accountId)"
                    [disabled]="!connection.active"
                  >
                    Run sync
                  </dp-button>
                </div>
              </td>
            </tr>
            </tbody>
          </table>
        </dp-table>

        <ng-template #emptyState>
          <dp-empty-state
            title="Нет подключений для мониторинга"
            description="Создайте подключение, чтобы отслеживать синхронизацию."
          >
            <dp-button variant="primary" (click)="openConnection(vm.accountId)">
              Create connection
            </dp-button>
          </dp-empty-state>
        </ng-template>
      </ng-container>
    </section>
  </dp-page-layout>
</ng-container>
