<!-- connections-page.component.html -->
<ng-container *ngIf="vm$ | async as vm">
  <dp-page-layout [accountId]="vm.accountId">
    <dp-page-header
      title="Connections"
      subtitle="Управляйте подключениями и синхронизациями данных."
    >
    </dp-page-header>

    <section class="card connections-card">
      <dp-table-toolbar>
        <div filters class="toolbar">
          <dp-form-field label="Marketplace">
            <dp-select [formControl]="marketplaceFilterControl">
              <option value="">All marketplaces</option>
              <option *ngFor="let marketplace of marketplaceOptions" [value]="marketplace">
                {{ marketplace }}
              </option>
            </dp-select>
          </dp-form-field>
        </div>
      </dp-table-toolbar>

      <ng-container *ngIf="vm.state.status === 'loading'">
        <dp-loading-state label="Loading connections"></dp-loading-state>
      </ng-container>

      <ng-container *ngIf="vm.state.status === 'error'">
        <dp-error-state
          title="Не удалось загрузить подключения"
          [description]="vm.state.error.message"
        >
          <dp-button variant="secondary" (click)="refresh()">Retry</dp-button>
        </dp-error-state>
      </ng-container>

      <ng-container *ngIf="vm.state.status === 'ready'">
        <dp-table *ngIf="filteredConnections(vm.state.data).length; else emptyState">
          <table class="connections-table">
            <thead>
            <tr>
              <th>
                <div class="th-inner">Connection</div>
              </th>

              <th class="th-status">
                <div class="th-inner">Status</div>
              </th>

              <th class="th-date">
                <div class="th-inner">Created at</div>
              </th>

              <th class="th-date">
                <div class="th-inner">Updated at</div>
              </th>

              <th class="th-actions">
                <div class="th-inner th-inner--actions">
                  <span class="th-actions__label">Actions</span>

                  <button
                    type="button"
                    class="dp-icon-btn dp-icon-btn--accent dp-icon-btn--plus"
                    aria-label="Create connection"
                    title="Create connection"
                    [disabled]="saving"
                    (click)="openWizard()"
                  >
                    +
                  </button>
                </div>
              </th>
            </tr>
            </thead>

            <tbody>
            <tr *ngFor="let connection of filteredConnections(vm.state.data)">
              <td>
                <div class="cell-title">{{ connection.marketplace }}</div>
                <div class="cell-subtitle">ID: {{ connection.id }}</div>
              </td>

              <td>
                <span [class]="getStatusClass(connection)">{{ getStatusLabel(connection) }}</span>
              </td>

              <td class="td-date">
                <span class="cell-date">{{ connection.createdAt | date: 'short' }}</span>
              </td>

              <td class="td-date">
                <span class="cell-date" *ngIf="connection.updatedAt; else noUpdatedAt">
                  {{ connection.updatedAt | date: 'short' }}
                </span>
                <ng-template #noUpdatedAt>
                  <span class="cell-date cell-date--empty">—</span>
                </ng-template>
              </td>

              <td class="td-actions">
                <div class="actions">
                  <div class="row-menu">
                    <button
                      type="button"
                      class="dp-icon-btn dp-icon-btn--ghost"
                      aria-label="More actions"
                      title="More"
                      [disabled]="saving"
                      (click)="toggleActionMenu(connection.id, $event)"
                    >
                      ⋯
                    </button>

                    <div
                      class="row-menu__backdrop"
                      *ngIf="openActionMenuId === connection.id"
                      (click)="closeActionMenu()"
                    ></div>

                    <div class="row-menu__panel" *ngIf="openActionMenuId === connection.id">
                      <button
                        type="button"
                        class="row-menu__item"
                        (click)="openEditModal(connection); closeActionMenu()"
                      >
                        Edit
                      </button>

                      <div class="row-menu__divider"></div>

                      <button
                        *ngIf="connection.active; else enableAction"
                        type="button"
                        class="row-menu__item"
                        (click)="requestDisable(connection); closeActionMenu()"
                      >
                        Disable
                      </button>

                      <ng-template #enableAction>
                        <button
                          type="button"
                          class="row-menu__item"
                          (click)="requestEnable(connection); closeActionMenu()"
                        >
                          Enable
                        </button>
                      </ng-template>

                      <div class="row-menu__divider"></div>

                      <button
                        type="button"
                        class="row-menu__item row-menu__item--danger"
                        (click)="requestDelete(connection); closeActionMenu()"
                      >
                        Delete
                      </button>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
            </tbody>
          </table>
        </dp-table>

        <ng-template #emptyState>
          <dp-empty-state
            title="Нет подключений"
            description="Подключите маркетплейс, чтобы начать синхронизацию."
          >
            <dp-button variant="primary" (click)="openWizard()">Create connection</dp-button>
          </dp-empty-state>
        </ng-template>
      </ng-container>
    </section>

    <!-- Create wizard -->
    <dp-modal [visible]="wizardVisible" (close)="closeWizard()">
      <div class="modal-content">
        <div class="wizard-header">
          <h3>Create connection</h3>
          <p class="muted">Step: {{ wizardStepLabel }}</p>
        </div>

        <form [formGroup]="wizardForm" class="wizard-form">
          <div *ngIf="wizardStep === 'marketplace'">
            <dp-form-field label="Marketplace" [required]="true">
              <dp-select formControlName="marketplace">
                <option *ngFor="let marketplace of marketplaceOptions" [value]="marketplace">
                  {{ marketplace }}
                </option>
              </dp-select>
            </dp-form-field>
          </div>

          <div *ngIf="wizardStep === 'credentials'" class="wizard-step">
            <p class="muted">Введите credentials. Мы проверим доступ перед созданием подключения.</p>

            <ng-container *ngIf="wizardIsWildberries; else ozonCredentials">
              <dp-form-field
                label="Token"
                [required]="true"
                hint="Где взять: WB seller → API access."
              >
                <dp-input
                  name="wizard-wb-token"
                  type="password"
                  formControlName="token"
                  [disabled]="isValidating"
                  [attr.autocomplete]="'new-password'"
                ></dp-input>
              </dp-form-field>
            </ng-container>

            <ng-template #ozonCredentials>
              <dp-form-field label="Client ID" [required]="true" hint="Ozon → API keys.">
                <dp-input
                  name="wizard-ozon-clientId"
                  formControlName="clientId"
                  [disabled]="isValidating"
                  [attr.autocomplete]="'off'"
                ></dp-input>
              </dp-form-field>

              <dp-form-field label="API Key" [required]="true">
                <dp-input
                  name="wizard-ozon-apiKey"
                  type="password"
                  formControlName="apiKey"
                  [disabled]="isValidating"
                  [attr.autocomplete]="'new-password'"
                ></dp-input>
              </dp-form-field>
            </ng-template>

            <dp-loading-state *ngIf="isValidating" label="Checking credentials"></dp-loading-state>

            <p class="error-text" *ngIf="wizardError">{{ wizardError }}</p>

            <dp-button
              variant="secondary"
              *ngIf="wizardError && !isValidating"
              (click)="validateCredentials()"
            >
              Retry validation
            </dp-button>
          </div>
        </form>

        <div class="modal-actions">
          <dp-button variant="secondary" (click)="closeWizard()" [disabled]="isValidating">
            Cancel
          </dp-button>

          <dp-button
            variant="primary"
            *ngIf="wizardStep === 'marketplace' || wizardStep === 'credentials'"
            (click)="nextWizardStep()"
            [loading]="isValidating"
            [disabled]="isValidating"
          >
            Next
          </dp-button>
        </div>
      </div>
    </dp-modal>

    <!-- Edit -->
    <dp-modal [visible]="editVisible" (close)="closeEditModal()">
      <div class="modal-content">
        <h3>Edit connection</h3>
        <p class="muted">Поля пустые — значит значение не меняем. Обновим только то, что заполнено.</p>

        <form [formGroup]="editForm" (ngSubmit)="submitEdit()" class="form">
          <ng-container *ngIf="editIsWildberries; else editOzon">
            <dp-form-field label="Token">
              <dp-input
                [name]="'edit-wb-token-' + (editingConnection?.id ?? 0)"
                type="password"
                formControlName="token"
                placeholder="Leave empty to keep current"
                (focus)="clearEditControl('token')"
                [attr.autocomplete]="'new-password'"
              ></dp-input>
            </dp-form-field>
          </ng-container>

          <ng-template #editOzon>
            <dp-form-field label="Client ID">
              <dp-input
                [name]="'edit-ozon-clientId-' + (editingConnection?.id ?? 0)"
                formControlName="clientId"
                placeholder="Leave empty to keep current"
                (focus)="clearEditControl('clientId')"
                [attr.autocomplete]="'off'"
              ></dp-input>
            </dp-form-field>

            <dp-form-field label="API Key">
              <dp-input
                [name]="'edit-ozon-apiKey-' + (editingConnection?.id ?? 0)"
                type="password"
                formControlName="apiKey"
                placeholder="Leave empty to keep current"
                (focus)="clearEditControl('apiKey')"
                [attr.autocomplete]="'new-password'"
              ></dp-input>
            </dp-form-field>
          </ng-template>

          <div class="modal-actions">
            <dp-button variant="secondary" type="button" (click)="closeEditModal()">
              Cancel
            </dp-button>
            <dp-button variant="primary" type="submit" [loading]="saving">Save</dp-button>
          </div>
        </form>
      </div>
    </dp-modal>

    <!-- Confirm dialogs -->
    <dp-confirm-dialog
      [visible]="deleteDialogVisible"
      title="Delete connection?"
      description="Удаление разорвет синхронизацию и удалит данные подключения."
      confirmLabel="Delete"
      [danger]="true"
      (confirm)="deleteConnection()"
      (cancel)="closeDeleteDialog()"
      [loading]="saving"
    ></dp-confirm-dialog>

    <dp-confirm-dialog
      [visible]="disableDialogVisible"
      title="Disable connection?"
      description="Синхронизация остановится до повторного включения."
      confirmLabel="Disable"
      (confirm)="disableConnection()"
      (cancel)="closeDisableDialog()"
      [loading]="saving"
    ></dp-confirm-dialog>

    <dp-confirm-dialog
      [visible]="enableDialogVisible"
      title="Enable connection?"
      description="Синхронизация будет снова доступна для запуска."
      confirmLabel="Enable"
      (confirm)="enableConnection()"
      (cancel)="closeEnableDialog()"
      [loading]="saving"
    ></dp-confirm-dialog>
  </dp-page-layout>
</ng-container>
