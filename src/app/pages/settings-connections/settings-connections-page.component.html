<ng-container *ngIf="vm$ | async as vm">
  <dp-dashboard-shell
    [accountId]="vm.accountId"
    title="Подключения"
    subtitle="Управление подключениями marketplace в рабочем пространстве"
  >
    <ng-container topbar-actions>
      <dp-button type="button" variant="primary" (click)="openCreateModal()">
        Добавить подключение
      </dp-button>
    </ng-container>

    <div class="page">
      <div class="controls-row">
        <p class="muted">Список активных подключений marketplace.</p>
        <dp-button type="button" variant="secondary" (click)="refresh()">Обновить</dp-button>
      </div>

      <section class="table-card">
        <div class="table-header">
          <div>
            <h3>Подключения</h3>
            <p class="muted">Управляйте подключениями и синхронизацией.</p>
          </div>
        </div>

        <div *ngIf="vm.state.status === 'loading'">
          <dp-loader label="Загружаем подключения..."></dp-loader>
        </div>

        <div class="error-text" *ngIf="vm.state.status === 'error'">
          {{ vm.state.error.message }}
        </div>

        <ng-container *ngIf="vm.state.status === 'ready'">
          <dp-connections-table
            *ngIf="vm.state.data.length > 0; else emptyState"
            [connections]="vm.state.data"
            (editConnection)="openEditModal($event)"
            (deleteConnection)="confirmDelete($event)"
          ></dp-connections-table>
          <ng-template #emptyState>
            <div class="empty-state">
              <p class="muted">Подключений пока нет.</p>
              <dp-button type="button" variant="primary" (click)="openCreateModal()">
                Добавить подключение
              </dp-button>
            </div>
          </ng-template>
        </ng-container>
      </section>
    </div>

    <dp-modal [visible]="createModalVisible" (close)="closeCreateModal()">
      <div class="modal-content">
        <h3>Добавить подключение</h3>
        <form class="form" [formGroup]="createForm" (ngSubmit)="submitCreate()">
          <label>
            Marketplace
            <select formControlName="marketplace">
              <option *ngFor="let marketplace of marketplaceOptions" [value]="marketplace">
                {{ marketplace }}
              </option>
            </select>
          </label>

          <ng-container *ngIf="createIsWildberries; else createOzonBlock">
            <label>
              Token
              <dp-input type="password" placeholder="Token" formControlName="token"></dp-input>
            </label>
          </ng-container>
          <ng-template #createOzonBlock>
            <label>
              Client ID
              <dp-input placeholder="Client ID" formControlName="clientId"></dp-input>
            </label>
            <label>
              API Key
              <dp-input type="password" placeholder="API Key" formControlName="apiKey"></dp-input>
            </label>
          </ng-template>

          <label class="checkbox">
            <input type="checkbox" formControlName="active" />
            Активно
          </label>

          <div class="modal-actions">
          <dp-button type="button" variant="secondary" (click)="closeCreateModal()">
            Отмена
          </dp-button>
          <dp-button type="submit" variant="primary" [disabled]="saving">
            {{ saving ? "Сохраняем..." : "Сохранить" }}
          </dp-button>
          </div>
        </form>
      </div>
    </dp-modal>

    <dp-modal [visible]="editModalVisible" (close)="closeEditModal()">
      <div class="modal-content">
        <h3>Редактировать подключение</h3>
        <p class="muted">
          Marketplace: {{ editingConnection?.marketplace }}. Введите новые credentials, чтобы заменить.
        </p>
        <form class="form" [formGroup]="editForm" (ngSubmit)="submitEdit()">
          <ng-container *ngIf="editIsWildberries; else editOzonBlock">
            <label>
              Token
              <dp-input
                type="password"
                placeholder="Введите новый token"
                formControlName="token"
              ></dp-input>
            </label>
          </ng-container>
          <ng-template #editOzonBlock>
            <label>
              Client ID
              <dp-input placeholder="Введите Client ID" formControlName="clientId"></dp-input>
            </label>
            <label>
              API Key
              <dp-input
                type="password"
                placeholder="Введите API Key"
                formControlName="apiKey"
              ></dp-input>
            </label>
          </ng-template>

          <label class="checkbox">
            <input type="checkbox" formControlName="active" />
            Активно
          </label>

          <div class="modal-actions">
            <dp-button type="button" variant="secondary" (click)="closeEditModal()">
              Отмена
            </dp-button>
            <dp-button type="submit" variant="primary" [disabled]="saving">
              {{ saving ? "Сохраняем..." : "Сохранить" }}
            </dp-button>
          </div>
        </form>
      </div>
    </dp-modal>

    <dp-modal [visible]="deleteModalVisible" (close)="closeDeleteModal()">
      <div class="modal-content">
        <h3>Удалить подключение?</h3>
        <p class="muted">Это действие необратимо.</p>
        <div class="modal-actions">
          <dp-button type="button" variant="secondary" (click)="closeDeleteModal()">
            Отмена
          </dp-button>
          <dp-button type="button" variant="danger" [disabled]="saving" (click)="deleteConnection()">
            {{ saving ? "Удаляем..." : "Удалить" }}
          </dp-button>
        </div>
      </div>
    </dp-modal>
  </dp-dashboard-shell>
</ng-container>
