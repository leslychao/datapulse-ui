<ng-container *ngIf="vm$ | async as vm">
  <dp-dashboard-shell
    [accountId]="vm.accountId"
    title="Connections"
    subtitle="Управление подключениями marketplace в рабочем пространстве"
  >
    <ng-container topbar-actions>
      <dp-button type="button" variant="primary" (click)="openCreateModal()">
        Add connection
      </dp-button>
    </ng-container>

    <div class="page">
      <div class="controls-row">
        <p class="muted">Список активных подключений marketplace.</p>
        <dp-button type="button" variant="secondary" (click)="refresh()">Refresh</dp-button>
      </div>

      <section class="table-card">
        <div class="table-header">
          <div>
            <h3>Connections</h3>
            <p class="muted">Управляйте подключениями и синхронизацией.</p>
          </div>
        </div>

        <div *ngIf="vm.state.status === 'loading'">
          <dp-loader label="Загружаем подключения..."></dp-loader>
        </div>

        <div class="error-text" *ngIf="vm.state.status === 'error'">
          {{ vm.state.error.message }}
        </div>

        <ng-container *ngIf="vm.state.status === 'ready'">
          <dp-connections-table
            *ngIf="vm.state.data.length > 0; else emptyState"
            [connections]="vm.state.data"
            (replaceCredentials)="openReplaceModal($event)"
            (toggleActive)="toggleActive($event)"
            (deleteConnection)="confirmDelete($event)"
          ></dp-connections-table>
          <ng-template #emptyState>
            <div class="empty-state">
              <p class="muted">Подключений пока нет.</p>
              <dp-button type="button" variant="primary" (click)="openCreateModal()">
                Add connection
              </dp-button>
            </div>
          </ng-template>
        </ng-container>
      </section>
    </div>

    <dp-modal [visible]="createModalVisible" (close)="closeCreateModal()">
      <div class="modal-content">
        <h3>Add connection</h3>
        <form class="form" [formGroup]="createForm" (ngSubmit)="submitCreate()">
          <label>
            Marketplace
            <select formControlName="marketplace">
              <option *ngFor="let marketplace of marketplaceOptions" [value]="marketplace">
                {{ marketplace }}
              </option>
            </select>
          </label>

          <ng-container *ngIf="createIsWildberries; else createOzonBlock">
            <label>
              Token
              <dp-input type="password" placeholder="Token" formControlName="token"></dp-input>
            </label>
          </ng-container>
          <ng-template #createOzonBlock>
            <label>
              Client ID
              <dp-input placeholder="Client ID" formControlName="clientId"></dp-input>
            </label>
            <label>
              API Key
              <dp-input type="password" placeholder="API Key" formControlName="apiKey"></dp-input>
            </label>
          </ng-template>

          <div class="modal-actions">
            <dp-button type="button" variant="secondary" (click)="closeCreateModal()">
              Cancel
            </dp-button>
            <dp-button type="submit" variant="primary" [disabled]="saving">
              {{ saving ? "Saving..." : "Save" }}
            </dp-button>
          </div>
        </form>
      </div>
    </dp-modal>

    <dp-modal [visible]="replaceModalVisible" (close)="closeReplaceModal()">
      <div class="modal-content">
        <h3>Replace credentials</h3>
        <p class="muted">Введите новые credentials. Старые будут заменены.</p>
        <form class="form" [formGroup]="replaceForm" (ngSubmit)="submitReplace()">
          <ng-container *ngIf="replaceIsWildberries; else replaceOzonBlock">
            <label>
              Token
              <dp-input type="password" placeholder="Token" formControlName="token"></dp-input>
            </label>
          </ng-container>
          <ng-template #replaceOzonBlock>
            <label>
              Client ID
              <dp-input placeholder="Client ID" formControlName="clientId"></dp-input>
            </label>
            <label>
              API Key
              <dp-input type="password" placeholder="API Key" formControlName="apiKey"></dp-input>
            </label>
          </ng-template>

          <div class="modal-actions">
            <dp-button type="button" variant="secondary" (click)="closeReplaceModal()">
              Cancel
            </dp-button>
            <dp-button type="submit" variant="primary" [disabled]="saving">
              {{ saving ? "Replacing..." : "Replace" }}
            </dp-button>
          </div>
        </form>
      </div>
    </dp-modal>

    <dp-modal [visible]="deleteModalVisible" (close)="closeDeleteModal()">
      <div class="modal-content">
        <h3>Delete connection?</h3>
        <p class="muted">This action cannot be undone.</p>
        <div class="modal-actions">
          <dp-button type="button" variant="secondary" (click)="closeDeleteModal()">
            Cancel
          </dp-button>
          <dp-button type="button" variant="danger" [disabled]="saving" (click)="deleteConnection()">
            {{ saving ? "Deleting..." : "Delete" }}
          </dp-button>
        </div>
      </div>
    </dp-modal>
  </dp-dashboard-shell>
</ng-container>
