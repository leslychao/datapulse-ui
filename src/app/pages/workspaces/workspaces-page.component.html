<ng-container *ngIf="vm$ | async as vm">
  <dp-page-layout [accountId]="vm.selectedAccount?.id ?? null">
    <dp-page-header title="Workspaces" subtitle="Выберите рабочее пространство или создайте новое.">
      <div primary-action>
        <dp-button variant="primary" (click)="goToCreateWorkspace()">
          Create workspace
        </dp-button>
      </div>
      <div secondary-actions>
        <dp-button variant="secondary" (click)="refreshAccounts()">Refresh</dp-button>
      </div>
    </dp-page-header>

    <section class="card">
      <dp-table-toolbar>
        <div filters>
          <dp-form-field label="Search">
            <dp-input placeholder="Workspace name" [formControl]="searchControl"></dp-input>
          </dp-form-field>
        </div>
      </dp-table-toolbar>

      <ng-container *ngIf="vm.accountsState.status === 'loading'">
        <dp-loading-state label="Loading workspaces"></dp-loading-state>
      </ng-container>

      <ng-container *ngIf="vm.accountsState.status === 'error'">
        <dp-error-state
          title="Не удалось загрузить рабочие пространства"
          [description]="vm.accountsState.error.message"
        >
          <dp-button variant="secondary" (click)="refreshAccounts()">Retry</dp-button>
        </dp-error-state>
      </ng-container>

      <ng-container *ngIf="vm.accountsState.status === 'ready'">
        <dp-table *ngIf="vm.filteredAccounts.length; else emptyState">
          <table>
            <thead>
              <tr>
                <th>Workspace</th>
                <th>Status</th>
                <th>Connections</th>
                <th>Users</th>
                <th>Last sync</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let account of vm.filteredAccounts">
                <td>
                  <div class="cell-title">{{ account.name }}</div>
                  <div class="cell-subtitle">ID: {{ account.id }}</div>
                </td>
                <td>
                  <span class="status-pill" [class.is-disabled]="!account.active">
                    {{ account.active ? "Active" : "Archived" }}
                  </span>
                </td>
                <td>{{ vm.detailsState.status === 'ready' && vm.selectedAccount?.id === account.id ? vm.detailsState.data.connections.length : "—" }}</td>
                <td>{{ vm.detailsState.status === 'ready' && vm.selectedAccount?.id === account.id ? vm.detailsState.data.members.length : "—" }}</td>
                <td>
                  {{
                    vm.detailsState.status === 'ready' && vm.selectedAccount?.id === account.id
                      ? (getLastSyncAt(vm.detailsState.data.connections) | date: 'short') || '—'
                      : '—'
                  }}
                </td>
                <td>
                  <div class="actions">
                    <dp-button size="sm" variant="primary" (click)="goToWorkspace(account.id)">
                      Open
                    </dp-button>
                    <dp-button size="sm" variant="secondary" (click)="goToSettings(account.id)">
                      Settings
                    </dp-button>
                    <dp-button
                      size="sm"
                      variant="secondary"
                      (click)="openArchiveDialog(account)"
                      [disabled]="!account.active"
                    >
                      Archive
                    </dp-button>
                    <dp-button
                      size="sm"
                      variant="danger"
                      (click)="openDeleteDialog(account)"
                      [disabled]="!canDelete(vm.filteredAccounts.length)"
                    >
                      Delete
                    </dp-button>
                  </div>
                  <div class="hint" *ngIf="!canDelete(vm.filteredAccounts.length)">
                    Нельзя удалить последний workspace.
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </dp-table>
        <ng-template #emptyState>
          <dp-empty-state
            title="Workspaces отсутствуют"
            description="Создайте workspace, чтобы подключить данные и начать работу."
          >
            <dp-button variant="primary" (click)="goToCreateWorkspace()">
              Create workspace
            </dp-button>
          </dp-empty-state>
        </ng-template>
      </ng-container>
    </section>

    <section class="card" *ngIf="vm.selectedAccount as selected">
      <div class="section-header">
        <div>
          <h3>What’s next</h3>
          <p class="muted">Следующие шаги после выбора workspace.</p>
        </div>
      </div>
      <div class="next-steps">
        <div class="next-step">
          <div class="next-step__title">Connect a data source</div>
          <div class="next-step__desc">Добавьте подключение к маркетплейсу.</div>
          <dp-button size="sm" variant="primary" (click)="goToConnections(selected.id)">
            Create connection
          </dp-button>
        </div>
        <div class="next-step">
          <div class="next-step__title">Invite your team</div>
          <div class="next-step__desc">Добавьте пользователей и роли.</div>
          <dp-button size="sm" variant="secondary" (click)="goToUsers(selected.id)">
            Invite users
          </dp-button>
        </div>
        <div class="next-step">
          <div class="next-step__title">Open dashboards</div>
          <div class="next-step__desc">Перейдите к аналитике и метрикам.</div>
          <dp-button size="sm" variant="secondary" (click)="goToWorkspace(selected.id)">
            View analytics
          </dp-button>
        </div>
      </div>
    </section>

    <dp-confirm-dialog
      [visible]="archiveDialogVisible"
      title="Archive workspace?"
      description="Workspace станет недоступен для синхронизаций и пользователей."
      confirmLabel="Archive"
      [loading]="saving"
      (confirm)="archiveWorkspace()"
      (cancel)="closeArchiveDialog()"
    ></dp-confirm-dialog>

    <dp-confirm-dialog
      [visible]="deleteDialogVisible"
      title="Delete workspace?"
      description="Удаление необратимо и затронет подключения и пользователей."
      confirmLabel="Delete"
      [danger]="true"
      [loading]="saving"
      (confirm)="deleteWorkspace()"
      (cancel)="closeDeleteDialog()"
    ></dp-confirm-dialog>
  </dp-page-layout>
</ng-container>
