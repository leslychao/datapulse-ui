<ng-container *ngIf="vm$ | async as vm">
  <dp-page-layout [accountId]="vm.selectedAccount?.id ?? null">
    <dp-page-header
      title="Workspaces"
      subtitle="Выберите workspace, чтобы открыть данные."
    >
    </dp-page-header>

    <section class="card">
      <ng-container *ngIf="vm.accountsState.status === 'loading'">
        <dp-loading-state label="Loading workspaces"></dp-loading-state>
      </ng-container>

      <ng-container *ngIf="vm.accountsState.status === 'error'">
        <dp-error-state
          title="Не удалось загрузить рабочие пространства"
          [description]="vm.accountsState.error.message"
        >
          <dp-button variant="secondary" (click)="refreshAccounts()">Retry</dp-button>
        </dp-error-state>
      </ng-container>

      <ng-container *ngIf="vm.accountsState.status === 'ready'">
        <dp-table *ngIf="vm.accountsState.data.length; else emptyState">
          <table>
            <thead>
            <tr>
              <th class="col-workspace">Workspace</th>
              <th class="col-lifecycle">Lifecycle</th>
              <th class="col-sources">Data sources</th>
              <th class="col-members">Members</th>
              <th class="col-last-sync">Last sync</th>

              <th class="col-actions th-actions">
                <div class="th-actions__inner">
                  <span>Actions</span>

                  <button
                    type="button"
                    class="dp-icon-btn dp-icon-btn--accent"
                    aria-label="Create workspace"
                    title="Create workspace"
                    [disabled]="saving"
                    (click)="goToCreateWorkspace()"
                  >
                    +
                  </button>
                </div>
              </th>
            </tr>
            </thead>

            <tbody>
            <tr *ngFor="let account of vm.accountsState.data" class="workspace-row">
              <td class="col-workspace">
                <button
                  type="button"
                  class="workspace-link"
                  (click)="goToWorkspace(account.id)"
                  aria-label="Open workspace"
                >
                  <div class="cell-title">
                    {{ account.name }}
                    <span class="current-pill" *ngIf="vm.currentAccountId === account.id">
                        Current
                      </span>
                  </div>
                  <div class="cell-subtitle">ID: {{ account.id }}</div>
                </button>
              </td>

              <td class="col-lifecycle">
                  <span class="status-pill" [class.is-disabled]="!account.active">
                    {{ getWorkspaceLabel(account) }}
                  </span>
              </td>

              <td class="col-sources">
                <ng-container
                  *ngIf="getDetailsForAccount(account.id, vm.detailsState) as details; else loadingDataSources"
                >
                  <ng-container *ngIf="details.connections.length; else noSources">
                    <div class="data-sources">
                        <span
                          class="data-sources__chip"
                          *ngFor="let badge of getDataSourceBadges(details.connections)"
                          [class.is-ok]="badge.tone === 'ok'"
                          [class.is-warning]="badge.tone === 'warning'"
                          [class.is-error]="badge.tone === 'error'"
                          [class.is-muted]="badge.tone === 'muted'"
                        >
                          {{ badge.label }}
                        </span>

                      <div class="data-sources__popover">
                        <div
                          class="data-sources__popover-item"
                          *ngFor="let connection of details.connections"
                        >
                          {{ connection.marketplace === 'WILDBERRIES' ? 'WB' : 'Ozon' }}
                          •
                          {{ getConnectionStatusLabel(connection.lastSyncStatus) }}
                        </div>
                      </div>
                    </div>
                  </ng-container>

                  <ng-template #noSources>
                    <span class="muted">No data sources</span>
                  </ng-template>
                </ng-container>

                <ng-template #loadingDataSources>
                  <span class="muted">—</span>
                </ng-template>
              </td>

              <td class="col-members">
                <ng-container
                  *ngIf="getDetailsForAccount(account.id, vm.detailsState) as details; else loadingMembers"
                >
                  <div class="members" *ngIf="details.members.length; else noMembers">
                    <span>{{ getMemberLabel(details.members.length) }}</span>
                    <div class="members__popover">
                      <div class="members__popover-item" *ngFor="let member of details.members">
                        {{ member.fullName || member.email || "Member" }}
                      </div>
                    </div>
                  </div>

                  <ng-template #noMembers>
                    <span class="muted">No members</span>
                  </ng-template>
                </ng-container>

                <ng-template #loadingMembers>
                  <span class="muted">—</span>
                </ng-template>
              </td>

              <td class="col-last-sync">
                <ng-container
                  *ngIf="getDetailsForAccount(account.id, vm.detailsState) as details; else loadingSync"
                >
                  <ng-container *ngIf="getLastSyncSummary(details.connections) as summary">
                    <ng-container *ngIf="summary.timestamp; else noSyncReason">
                      <div class="last-sync">
                        <span>{{ summary.timestamp | date: 'short' }}</span>
                        <span class="dot">•</span>
                        <span>{{ summary.statusLabel }}</span>
                      </div>
                    </ng-container>

                    <ng-template #noSyncReason>
                      <span class="muted">{{ summary.reason }}</span>
                    </ng-template>
                  </ng-container>
                </ng-container>

                <ng-template #loadingSync>
                  <span class="muted">—</span>
                </ng-template>
              </td>

              <td class="col-actions td-actions">
                <div class="row-actions">
                  <div class="row-menu">
                    <button
                      type="button"
                      class="dp-icon-btn"
                      aria-label="More actions"
                      title="More"
                      (click)="toggleActionMenu(account.id, $event); $event.stopPropagation()"
                    >
                      ⋯
                    </button>

                    <div
                      class="row-menu__backdrop"
                      *ngIf="openActionMenuId === account.id"
                      (click)="closeActionMenu()"
                    ></div>

                    <div
                      class="row-menu__panel"
                      *ngIf="openActionMenuId === account.id"
                      (click)="$event.stopPropagation()"
                    >
                      <button
                        type="button"
                        class="row-menu__item"
                        (click)="goToSettings(account.id); closeActionMenu(); $event.stopPropagation()"
                      >
                        Settings
                      </button>

                      <button
                        type="button"
                        class="row-menu__item"
                        (click)="openArchiveDialog(account); closeActionMenu(); $event.stopPropagation()"
                        [disabled]="!account.active"
                      >
                        Archive
                      </button>

                      <button
                        type="button"
                        class="row-menu__item row-menu__item--danger"
                        (click)="openDeleteDialog(account); closeActionMenu(); $event.stopPropagation()"
                        [disabled]="!canDelete(vm.accountsState.data.length)"
                      >
                        Delete
                      </button>

                      <div class="row-menu__hint" *ngIf="!canDelete(vm.accountsState.data.length)">
                        Нельзя удалить последний workspace.
                      </div>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
            </tbody>
          </table>
        </dp-table>

        <ng-template #emptyState>
          <dp-empty-state
            title="Create your first workspace"
            description="Workspace нужен, чтобы подключить данные и запустить аналитику."
          >
            <dp-button variant="primary" (click)="goToCreateWorkspace()">
              Create workspace
            </dp-button>
          </dp-empty-state>
        </ng-template>
      </ng-container>
    </section>

    <dp-confirm-dialog
      [visible]="archiveDialogVisible"
      title="Archive workspace?"
      description="Workspace станет недоступен для синхронизаций и пользователей."
      confirmLabel="Archive"
      [loading]="saving"
      (confirm)="archiveWorkspace()"
      (cancel)="closeArchiveDialog()"
    ></dp-confirm-dialog>

    <dp-confirm-dialog
      [visible]="deleteDialogVisible"
      title="Delete workspace?"
      description="Удаление необратимо и затронет подключения и пользователей."
      confirmLabel="Delete"
      [danger]="true"
      [loading]="saving"
      (confirm)="deleteWorkspace()"
      (cancel)="closeDeleteDialog()"
    ></dp-confirm-dialog>
  </dp-page-layout>
</ng-container>
