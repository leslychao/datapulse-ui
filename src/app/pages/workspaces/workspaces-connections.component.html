<ng-container *ngIf="vm$ | async as vm">
  <section class="table-card">
    <header class="table-header">
      <div>
        <h2>Connections</h2>
        <p class="muted">Управляйте подключениями marketplace для workspace.</p>
      </div>
      <dp-button type="button" variant="primary" (click)="openCreateModal()">
        Add connection
      </dp-button>
    </header>

    <div *ngIf="vm.state.status === 'loading'">
      <dp-loader label="Загружаем подключения..."></dp-loader>
    </div>

    <div class="error-text" *ngIf="vm.state.status === 'error'">
      {{ vm.state.error.message }}
    </div>

    <ng-container *ngIf="vm.state.status === 'ready'">
      <dp-connections-table
        *ngIf="vm.state.data.length > 0; else emptyState"
        [connections]="vm.state.data"
        (replaceCredentials)="openReplaceModal($event)"
        (deleteConnection)="confirmDelete($event)"
      ></dp-connections-table>
      <ng-template #emptyState>
        <div class="empty-state">
          <p class="muted">Подключений пока нет.</p>
        </div>
      </ng-template>
    </ng-container>
  </section>

  <dp-modal [visible]="createModalVisible" (close)="closeCreateModal()">
    <div class="modal-content">
      <h2>Добавить подключение</h2>
      <form class="form" [formGroup]="createForm">
        <label>
          Marketplace
          <select formControlName="marketplace">
            <option *ngFor="let option of marketplaceOptions" [value]="option">
              {{ option }}
            </option>
          </select>
        </label>

        <ng-container *ngIf="createIsWildberries; else ozonFields">
          <label>
            Token
            <dp-input type="password" formControlName="token"></dp-input>
          </label>
        </ng-container>

        <ng-template #ozonFields>
          <label>
            Client ID
            <dp-input type="text" formControlName="clientId"></dp-input>
          </label>
          <label>
            API Key
            <dp-input type="password" formControlName="apiKey"></dp-input>
          </label>
        </ng-template>

        <label class="checkbox">
          <input type="checkbox" formControlName="active" />
          Активно
        </label>
      </form>
      <div class="modal-actions">
        <dp-button type="button" (click)="closeCreateModal()">Cancel</dp-button>
        <dp-button type="button" variant="primary" [disabled]="saving" (click)="submitCreate()">
          Save
        </dp-button>
      </div>
    </div>
  </dp-modal>

  <dp-modal [visible]="replaceModalVisible" (close)="closeReplaceModal()">
    <div class="modal-content">
      <h2>Обновить credentials</h2>
      <form class="form" [formGroup]="replaceForm">
        <ng-container *ngIf="replaceIsWildberries; else replaceOzonFields">
          <label>
            Token
            <dp-input type="password" formControlName="token"></dp-input>
          </label>
        </ng-container>

        <ng-template #replaceOzonFields>
          <label>
            Client ID
            <dp-input type="text" formControlName="clientId"></dp-input>
          </label>
          <label>
            API Key
            <dp-input type="password" formControlName="apiKey"></dp-input>
          </label>
        </ng-template>
      </form>
      <div class="modal-actions">
        <dp-button type="button" (click)="closeReplaceModal()">Cancel</dp-button>
        <dp-button type="button" variant="primary" [disabled]="saving" (click)="submitReplace()">
          Save
        </dp-button>
      </div>
    </div>
  </dp-modal>

  <dp-modal [visible]="deleteModalVisible" (close)="closeDeleteModal()">
    <div class="modal-content">
      <h2>Удалить подключение?</h2>
      <p class="muted">Подключение будет удалено и доступ к данным прекратится.</p>
      <div class="modal-actions">
        <dp-button type="button" (click)="closeDeleteModal()">Cancel</dp-button>
        <dp-button type="button" variant="danger" [disabled]="saving" (click)="deleteConnection()">
          Delete
        </dp-button>
      </div>
    </div>
  </dp-modal>
</ng-container>
