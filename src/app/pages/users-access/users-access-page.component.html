<ng-container *ngIf="vm$ | async as vm">
  <dp-page-layout [accountId]="vm.accountId">
    <dp-page-header
      title="Users & Access"
      subtitle="Управляйте ролями и доступом в workspace."
    ></dp-page-header>

    <section class="card users-access-card">
        <dp-table-toolbar>
          <div filters>
            <dp-form-field label="Status">
              <dp-select [formControl]="filterStatusControl">
                <option value="">All statuses</option>
                <option
                  *ngFor="let option of statusOptions; trackBy: trackByStatusOptionValue"
                  [value]="option.value"
                >
                  {{ option.label }}
                </option>
              </dp-select>
            </dp-form-field>

            <dp-form-field label="Search">
              <dp-input placeholder="User ID" [formControl]="searchControl"></dp-input>
            </dp-form-field>
          </div>
        </dp-table-toolbar>

        <ng-container [ngSwitch]="vm.state.status">
          <dp-loading-state *ngSwitchCase="'loading'" label="Loading users"></dp-loading-state>

          <ng-container *ngSwitchCase="'error'">
            <dp-error-state
              title="Не удалось загрузить пользователей"
              [description]="loadStateErrorMessage(vm.state)"
            >
              <dp-button variant="secondary" (click)="refresh()">Retry</dp-button>
            </dp-error-state>
          </ng-container>

          <ng-container *ngSwitchCase="'ready'">
            <ng-container *ngIf="vmUi(vm) as ui">
              <div class="summary-row">
                <div class="summary">
                  <span><strong>Users:</strong> {{ ui.summary.total }}</span>
                <span class="summary-sep">·</span>
                <span>Active: <strong>{{ ui.summary.active }}</strong></span>
                <span class="summary-sep">·</span>
                <span>Inactive: <strong>{{ ui.summary.inactive }}</strong></span>
                </div>
              </div>

              <ng-container *ngIf="ui.filtered.length; else emptyState">
                <dp-table>
                  <table>
                    <thead>
                    <tr>
                      <th>User</th>
                      <th>Role</th>
                      <th>Status</th>
                      <th style="text-align:right;">Actions</th>
                    </tr>
                    </thead>

                    <tbody>
                    <tr *ngFor="let member of ui.filtered; trackBy: trackByMemberId">
                      <td class="row-content">
                        <div class="cell-title">{{ displayName(member) }}</div>
                        <div class="cell-subtitle">ID: {{ member.userId }}</div>
                      </td>

                      <td class="row-content">
                        <dp-select
                          class="role-select"
                          [value]="member.role"
                          (change)="onRoleSelectChange(member, $event)"
                          [disabled]="!ui.canManage || isLastOwner(member, ui.members) || !member.role || !member.status"
                        >
                          <option *ngFor="let role of roleOptions; trackBy: trackByRoleValue" [value]="role">
                            {{ role }}
                          </option>
                        </dp-select>

                        <div class="hint" *ngIf="isLastOwner(member, ui.members)">
                          Нельзя изменить роль последнего OWNER.
                        </div>
                      </td>

                      <td class="row-content">
                        <span class="status-pill">{{ statusLabel(member.status) }}</span>
                      </td>

                      <td>
                        <div class="actions" (click)="$event.stopPropagation()">
                          <dp-button
                            size="sm"
                            variant="secondary"
                            (click)="toggleMenu(member)"
                            [disabled]="ui.menuDisabled"
                          >
                            ⋯
                          </dp-button>

                          <div class="menu" *ngIf="isMenuOpenFor(member)">
                            <button
                              type="button"
                              class="menu-item"
                              *ngIf="member.status === statusEnum.Active"
                              (click)="onMenuDeactivate(member, vm.accountId, ui.members, vm.currentUserId)"
                              [disabled]="deactivateDisabled(member, ui.members, vm.currentUserId)"
                            >
                              Deactivate
                            </button>

                            <button
                              type="button"
                              class="menu-item"
                              *ngIf="member.status === statusEnum.Inactive"
                              (click)="onMenuActivate(member, vm.accountId, ui.members, vm.currentUserId)"
                              [disabled]="activateDisabled(member, vm.currentUserId, ui.members)"
                            >
                              Activate
                            </button>

                            <button
                              type="button"
                              class="menu-item menu-danger"
                              (click)="onMenuRemove(member, vm.accountId, ui.members, vm.currentUserId)"
                              [disabled]="removeDisabled(member, ui.members, vm.currentUserId)"
                            >
                              Remove from workspace
                            </button>

                            <div class="menu-hint" *ngIf="menuHint(member, ui.members, vm.currentUserId) as hint">
                              {{ hint }}
                            </div>
                          </div>
                        </div>

                        <div class="hint" *ngIf="!ui.canManage">
                          Недостаточно прав для управления пользователями.
                        </div>
                      </td>
                    </tr>
                    </tbody>
                  </table>
                </dp-table>
              </ng-container>

              <ng-template #emptyState>
                <dp-empty-state
                  title="Нет пользователей"
                  description="Добавьте участников, чтобы делегировать доступ."
                >
                  <dp-button variant="primary" [disabled]="true">Invite user</dp-button>
                </dp-empty-state>
              </ng-template>
            </ng-container>
          </ng-container>
        </ng-container>
    </section>

    <dp-confirm-dialog
      [visible]="confirmDialogVisible"
      [title]="confirmTitle()"
      [description]="confirmDescription(vm.currentUserId)"
      confirmLabel="Confirm"
      [danger]="confirmAction === 'remove'"
      [loading]="saving"
      (confirm)="confirmAction === 'role' ? confirmRoleChange(vm.accountId) : confirmActionRun(vm.accountId)"
      (cancel)="closeConfirm()"
    ></dp-confirm-dialog>
  </dp-page-layout>
</ng-container>
