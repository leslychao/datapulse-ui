<ng-container *ngIf="vm$ | async as vm">
  <dp-page-layout [accountId]="vm.accountId">
    <dp-page-header
      title="Users & Access"
      subtitle="Управляйте ролями и доступом в workspace."
    >
      <ng-container primary-action></ng-container>
    </dp-page-header>

    <section class="card tg-card">
      <div class="tg-top">
        <div class="tg-filters">
          <dp-form-field label="Status">
            <dp-select [formControl]="filterStatusControl">
              <option value="">All statuses</option>
              <option *ngFor="let option of statusOptions" [value]="option.value">
                {{ option.label }}
              </option>
            </dp-select>
          </dp-form-field>

          <dp-form-field label="Search">
            <dp-input placeholder="Email or name" [formControl]="searchControl"></dp-input>
          </dp-form-field>
        </div>
      </div>

      <ng-container *ngIf="vm.state.status === 'loading'">
        <dp-loading-state label="Loading users"></dp-loading-state>
      </ng-container>

      <ng-container *ngIf="vm.state.status === 'error'">
        <dp-error-state
          title="Не удалось загрузить пользователей"
          [description]="vm.state.error.message"
        >
          <dp-button variant="secondary" (click)="refresh()">Retry</dp-button>
        </dp-error-state>
      </ng-container>

      <ng-container *ngIf="vm.state.status === 'ready'">
        <div class="tg-stats-bar">
          <div class="tg-stats">
            <div class="tg-stat">
              <div class="tg-stat__label">Users</div>
              <div class="tg-stat__value">{{ vm.state.data.length }}</div>
            </div>

            <div class="tg-stat">
              <div class="tg-stat__label">Active</div>
              <div class="tg-stat__value">{{ countByStatus(vm.state.data, statusEnum.Active) }}</div>
            </div>

            <div class="tg-stat">
              <div class="tg-stat__label">Invited</div>
              <div class="tg-stat__value">{{ countByStatus(vm.state.data, statusEnum.Invited) }}</div>
            </div>

            <div class="tg-stat">
              <div class="tg-stat__label">Blocked</div>
              <div class="tg-stat__value">{{ countByStatus(vm.state.data, statusEnum.Blocked) }}</div>
            </div>
          </div>

          <button
            type="button"
            class="dp-icon-btn dp-icon-btn--accent"
            (click)="openInvite()"
            [disabled]="
              vm.state.status !== 'ready' ||
              !canManageUsers(currentMember(vm.state.data, vm.currentUserId)?.role ?? null)
            "
            aria-label="Invite user"
            title="Invite user"
          >
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <path
                d="M15 19.5c0-2.5-2.5-4.5-6-4.5S3 17 3 19.5V21h12v-1.5Z"
                fill="currentColor"
                opacity="0.9"
              />
              <path
                d="M9 13c2.2 0 4-1.8 4-4S11.2 5 9 5 5 6.8 5 9s1.8 4 4 4Z"
                fill="currentColor"
              />
              <path
                d="M19 8V6h-2v2h-2v2h2v2h2v-2h2V8h-2Z"
                fill="currentColor"
              />
            </svg>
          </button>
        </div>

        <ng-container *ngIf="filteredMembers(vm.state.data).length; else emptyState">
          <div class="tg-list">
            <div class="tg-head" role="row">
              <div class="tg-head__cell" role="columnheader">User</div>
              <div class="tg-head__cell" role="columnheader">Role</div>
              <div class="tg-head__cell" role="columnheader">Last activity</div>
              <div class="tg-head__cell tg-head__cell--actions" role="columnheader">Actions</div>
            </div>

            <div class="tg-row" *ngFor="let member of filteredMembers(vm.state.data)" role="row">
              <div class="tg-cell tg-cell--user" role="cell">
                <div class="tg-avatar" aria-hidden="true">
                  {{ memberInitials(member) }}
                </div>

                <div class="tg-meta">
                  <div class="tg-title">
                    <span class="tg-title__text">
                      {{ member.fullName || member.email || ('User #' + member.userId) }}
                    </span>

                    <span
                      class="status-pill"
                      [class.status-pill--active]="member.status === statusEnum.Active"
                      [class.status-pill--invited]="member.status === statusEnum.Invited"
                      [class.status-pill--blocked]="member.status === statusEnum.Blocked"
                    >
                      {{ statusLabel(member.status) }}
                    </span>
                  </div>

                  <div class="tg-subtitle">
                    {{ member.email || 'No email on file' }}
                  </div>
                </div>
              </div>

              <div class="tg-cell tg-cell--role" role="cell" (click)="$event.stopPropagation()">
                <dp-select
                  class="role-select"
                  [value]="member.role"
                  (change)="onRoleSelectChange(member, $event)"
                  [disabled]="
                    !canManageUsers(currentMember(vm.state.data, vm.currentUserId)?.role ?? null) ||
                    isLastOwner(member, vm.state.data)
                  "
                >
                  <option *ngFor="let role of roleOptions" [value]="role">{{ role }}</option>
                </dp-select>

                <div class="hint" *ngIf="isLastOwner(member, vm.state.data)">
                  Нельзя изменить роль последнего OWNER.
                </div>

                <div class="hint" *ngIf="!canManageUsers(currentMember(vm.state.data, vm.currentUserId)?.role ?? null)">
                  Недостаточно прав для управления пользователями.
                </div>
              </div>

              <div class="tg-cell tg-cell--activity" role="cell">
                <div class="tg-activity__value">
                  {{ member.lastActiveAt ? (member.lastActiveAt | date:'dd.MM.yyyy, HH:mm') : '—' }}
                </div>
                <div class="tg-activity__hint" *ngIf="member.lastActiveAt">
                  local time
                </div>
              </div>

              <div class="tg-cell tg-cell--actions" role="cell" (click)="$event.stopPropagation()">
                <dp-button
                  size="sm"
                  variant="secondary"
                  class="tg-action-resend"
                  *ngIf="member.status === statusEnum.Invited"
                  (click)="resendInvite(vm.accountId, member)"
                  [disabled]="!canManageUsers(currentMember(vm.state.data, vm.currentUserId)?.role ?? null)"
                >
                  Resend
                </dp-button>

                <button
                  type="button"
                  class="dp-icon-btn"
                  (click)="toggleMenu(member)"
                  [disabled]="menuDisabled(vm.state.data, vm.currentUserId)"
                  aria-label="Open actions"
                  title="More"
                >
                  ⋯
                </button>

                <div class="menu" *ngIf="isMenuOpenFor(member)">
                  <button
                    type="button"
                    class="menu-item"
                    (click)="onMenuBlock(member, vm.accountId, vm.state.data, vm.currentUserId)"
                    [disabled]="blockDisabled(member, vm.state.data, vm.currentUserId)"
                  >
                    Block
                  </button>

                  <button
                    type="button"
                    class="menu-item"
                    (click)="onMenuUnblock(member, vm.accountId, vm.state.data, vm.currentUserId)"
                    [disabled]="unblockDisabled(member, vm.currentUserId, vm.state.data)"
                  >
                    Unblock
                  </button>

                  <button
                    type="button"
                    class="menu-item"
                    *ngIf="member.status === statusEnum.Invited"
                    (click)="onMenuCancelInvite(member, vm.accountId, vm.currentUserId)"
                    [disabled]="!canManageUsers(currentMember(vm.state.data, vm.currentUserId)?.role ?? null)"
                  >
                    Cancel invite
                  </button>

                  <button
                    type="button"
                    class="menu-item menu-danger"
                    (click)="onMenuRemove(member, vm.accountId, vm.state.data, vm.currentUserId)"
                    [disabled]="removeDisabled(member, vm.state.data, vm.currentUserId)"
                  >
                    Remove from workspace
                  </button>

                  <div class="menu-hint" *ngIf="menuHint(member, vm.state.data, vm.currentUserId) as hint">
                    {{ hint }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </ng-container>

        <ng-template #emptyState>
          <dp-empty-state
            title="Нет пользователей"
            description="Пригласите коллег, чтобы работать вместе."
          >
            <button
              type="button"
              class="dp-icon-btn dp-icon-btn--accent"
              (click)="openInvite()"
              [disabled]="
                vm.state.status !== 'ready' ||
                !canManageUsers(currentMember(vm.state.data, vm.currentUserId)?.role ?? null)
              "
              aria-label="Invite user"
              title="Invite user"
            >
              <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                <path
                  d="M15 19.5c0-2.5-2.5-4.5-6-4.5S3 17 3 19.5V21h12v-1.5Z"
                  fill="currentColor"
                  opacity="0.9"
                />
                <path
                  d="M9 13c2.2 0 4-1.8 4-4S11.2 5 9 5 5 6.8 5 9s1.8 4 4 4Z"
                  fill="currentColor"
                />
                <path
                  d="M19 8V6h-2v2h-2v2h2v2h2v-2h2V8h-2Z"
                  fill="currentColor"
                />
              </svg>
            </button>
          </dp-empty-state>
        </ng-template>
      </ng-container>
    </section>

    <dp-invite-member-modal
      [visible]="inviteVisible"
      [saving]="saving"
      [existingMembers]="vm.state.status === 'ready' ? vm.state.data : []"
      (close)="closeInvite()"
      (submitInvite)="submitInvite(vm.accountId, $event)"
    ></dp-invite-member-modal>

    <dp-confirm-dialog
      [visible]="confirmDialogVisible"
      [title]="confirmTitle()"
      [description]="confirmDescription(vm.currentUserId)"
      confirmLabel="Confirm"
      cancelLabel="Cancel"
      [danger]="confirmAction === 'remove' || confirmAction === 'block' || confirmAction === 'cancel'"
      [loading]="saving"
      (confirm)="confirmAction === 'role' ? confirmRoleChange(vm.accountId) : confirmActionRun(vm.accountId)"
      (cancel)="closeConfirm()"
    ></dp-confirm-dialog>
  </dp-page-layout>
</ng-container>
