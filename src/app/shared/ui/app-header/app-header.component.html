<header class="app-header">
  <a class="brand-link" [routerLink]="homePath" aria-label="Datapulse — на главную">
    <img class="brand-icon" src="assets/logo.svg" alt="" />
    <span class="brand">Datapulse</span>
  </a>

  <div class="app-header__profile" *ngIf="userProfile$ | async as profile; else loginTemplate">
    <div class="profile-menu" cdkOverlayOrigin #menuTrigger="cdkOverlayOrigin">
      <button
        type="button"
        class="profile-trigger"
        (click)="toggleMenu()"
        [attr.aria-expanded]="isMenuOpen"
      >
        <div class="app-header__user">
          <span class="app-header__name">
            {{ profile.fullName || profile.username || profile.email || profile.keycloakSub }}
          </span>

          <span class="app-header__email" *ngIf="profile.email">
            {{ profile.email }}
          </span>
        </div>
        <span class="profile-menu__caret">▾</span>
      </button>
    </div>

    <ng-template
      cdkConnectedOverlay
      [cdkConnectedOverlayOrigin]="menuTrigger"
      [cdkConnectedOverlayOpen]="isMenuOpen"
      [cdkConnectedOverlayHasBackdrop]="true"
      cdkConnectedOverlayBackdropClass="profile-menu__backdrop"
      [cdkConnectedOverlayPanelClass]="'profile-menu__panel'"
      [cdkConnectedOverlayPositions]="[
        { originX: 'end', originY: 'bottom', overlayX: 'end', overlayY: 'top', offsetY: 8 }
      ]"
      (backdropClick)="closeMenu()"
      (overlayKeydown)="onOverlayKeydown($event)"
      (detach)="closeMenu()"
    >
      <div class="profile-menu__panel-content">
        <a class="profile-menu__item" [routerLink]="workspacesPath" (click)="closeMenu()">
          Workspaces
        </a>
        <button
          type="button"
          class="profile-menu__item"
          (click)="logout(); closeMenu()"
          [disabled]="isLogoutRedirecting"
        >
          Выйти
        </button>
      </div>
    </ng-template>
  </div>
  <ng-template #loginTemplate>
    <div class="app-header__profile">
      <dp-button
        type="button"
        variant="secondary"
        (click)="login()"
        [disabled]="isLoginRedirecting"
      >
        Войти
      </dp-button>
    </div>
  </ng-template>
</header>
